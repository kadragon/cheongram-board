# Environment Configuration

last_updated: 2025-11-06
project: cheongram-board
status: active

# Runtime Environment
runtime:
  platform: cloudflare-workers
  framework: nextjs  # Transitioning to: hono (Phase 2)
  adapter: opennextjs-cloudflare  # To be removed in Phase 2
  node_version: 18+
  typescript_version: 5.8.3

# Dependencies (Key)
dependencies:
  core:
    next: 15.3.5
    react: 19.1.0
    react-dom: 19.1.0
    typescript: 5.8.3

  cloudflare:
    '@opennextjs/cloudflare': 1.5.1  # Remove in Phase 2
    wrangler: 4.24.3
    '@cloudflare/workers-types': ^4.x

  validation:
    zod: 4.0.5

  ui:
    '@radix-ui/react-*': ^1.x
    tailwindcss: 4.1.11
    lucide-react: 0.525.0

  utilities:
    cheerio: 1.1.0  # Web scraping
    use-debounce: 10.0.5

  testing:
    jest: 30.0.4
    ts-jest: 29.4.0
    supertest: 7.1.3

# Cloudflare Bindings
bindings:
  d1:
    - binding: DB
      database_name: cheongram-board-db
      database_id: 77627225-92c1-4b09-94c9-d9cb6c9fcf88
      type: D1Database

  assets:
    binding: ASSETS
    directory: .open-next/assets

# Environment Variables
env_vars:
  development:
    NODE_ENV: development
    ADMIN_EMAILS: kangdongouk@gmail.com  # Set in .dev.vars
    NEXTJS_ENV: development

  production:
    NODE_ENV: production
    ADMIN_EMAILS: secret  # Set via wrangler secret put

  all:
    # Custom domain
    DOMAIN: crb.kadragon.work

# Database Configuration
database:
  type: d1_sqlite
  schema_version: 0001_initial_schema
  tables:
    - games
    - rentals

  indexes:
    - idx_games_title
    - idx_rentals_game_id
    - idx_rentals_returned_at
    - idx_rentals_active

  constraints:
    foreign_keys: enabled
    check_constraints: enabled

# API Configuration
api:
  base_path: /api
  response_format: json
  authentication: cloudflare_access  # + dev fallback

  endpoints:
    games:
      - GET /api/games (public)
      - POST /api/games (admin)
      - GET /api/games/:id (public)
      - PUT /api/games/:id (admin)
      - DELETE /api/games/:id (admin)

    rentals:
      - GET /api/rentals (admin)
      - POST /api/rentals (admin)
      - GET /api/rentals/:id (admin)
      - PUT /api/rentals/:id (admin)
      - DELETE /api/rentals/:id (admin)
      - POST /api/rentals/:id/return (admin)
      - POST /api/rentals/:id/extend (admin)

    utilities:
      - POST /api/scrape (admin)

# Paths and Directories
paths:
  root: /Users/kadragon/Dev/cheongram-board
  src: src/
  lib: src/lib/
  api: src/app/api/
  components: src/components/
  migrations: migrations/
  tests: src/**/__tests__/

  # Governance (SDD Ã— TDD)
  specs: .spec/
  tasks: .tasks/
  governance: .governance/

# Build Configuration
build:
  command: npm run build:worker  # Uses opennextjs-cloudflare build
  output: .open-next/
  worker_entry: .open-next/worker.js
  assets_dir: .open-next/assets

  # Phase 2 (planned)
  future:
    backend_build: cd workers && npm run build
    frontend_build: cd frontend && npm run build
    backend_output: workers/dist/
    frontend_output: frontend/dist/

# Deployment
deployment:
  platform: cloudflare

  production:
    domain: crb.kadragon.work
    worker_name: cheongram-board
    d1_database: cheongram-board-db
    command: npx wrangler deploy

  staging:
    domain: staging.crb.kadragon.work
    worker_name: cheongram-board-staging
    d1_database: cheongram-board-db-staging
    command: npx wrangler deploy --env staging

  development:
    command: npx wrangler dev --local
    port: 8787

# Testing Configuration
testing:
  framework: jest
  runner: ts-jest
  coverage:
    threshold:
      lines: 80
      branches: 70
      functions: 75
      statements: 80

  test_commands:
    unit: npm run test
    integration: npm run test:integration
    e2e: npm run test:e2e
    coverage: npm run test:coverage

# Quality Gates
quality_gates:
  required:
    - name: test_coverage
      command: npm run test:coverage
      threshold: 80%

    - name: type_check
      command: npm run typecheck
      threshold: zero_errors

    - name: linting
      command: npm run lint
      threshold: zero_errors

    - name: security_scan
      command: npm audit --audit-level=moderate
      threshold: zero_critical_high

    - name: license_check
      command: npx license-checker --production --failOn 'GPL;AGPL'
      threshold: compatible_only

    - name: bundle_size
      worker_max: 100KB  # Target for Phase 2
      worker_current: 500KB
      frontend_max: 500KB

# Performance Targets
performance:
  current:
    cold_start: 50-100ms
    api_response_p95: ~150ms
    db_query_simple: <10ms
    db_query_complex: <50ms

  targets:
    cold_start: <20ms  # Phase 2 goal
    api_response_p50: <50ms
    api_response_p95: <100ms
    api_response_p99: <300ms

# Monitoring
monitoring:
  logging:
    level: info
    format: json
    destination: console  # Cloudflare Logpush

  metrics:
    - request_duration
    - db_query_duration
    - error_count
    - cold_start_time

  alerts:
    error_rate_threshold: 1%
    response_time_p95_threshold: 300ms

# Migration Status
migration:
  phase1_supabase_to_d1:
    status: completed
    date: 2025-11-06
    blockers:
      - ADMIN_EMAILS env var access (workaround documented)

  phase2_opennext_to_workers:
    status: planned
    estimated_start: 2025-11-07
    estimated_duration: 5-7 days
    target:
      - Pure Hono backend on Workers
      - Static React frontend on Pages
      - No OpenNext dependency

# Contact and Ownership
ownership:
  project_owner: kadragon
  email: kangdongouk@gmail.com
  organization: Cheongram Church
  repository: (private)

# Important Reminders
reminders:
  - D1 database uses SQLite (not PostgreSQL)
  - All timestamps are TEXT (ISO 8601 format)
  - Environment variables require Symbol hack in OpenNext (fix in Phase 2)
  - Admin auth via ADMIN_EMAILS (comma-separated)
  - Use .dev.vars for local development
  - Always use prepared statements for D1 queries
  - No filesystem access in Workers (use D1, KV, or R2)

# Tools
tools:
  cli:
    - wrangler  # Cloudflare Workers CLI
    - npm       # Package manager
    - git       # Version control

  development:
    - vscode    # Recommended IDE
    - chrome    # Browser testing
    - modheader # Header modification for dev auth

  testing:
    - curl      # API testing
    - supertest # Integration testing
    - jest      # Unit testing

# External Services
external_services:
  authentication:
    - cloudflare_access
    - fallback: X-Dev-User-Email header (dev only)

  hosting:
    - cloudflare_workers (API)
    - cloudflare_pages (future: frontend)

  database:
    - cloudflare_d1 (production)
    - local_d1 (development)

  monitoring:
    - cloudflare_analytics
    - cloudflare_logs

# Deprecated
deprecated:
  removed_2025_11_06:
    - supabase (database)
    - '@supabase/ssr'
    - '@supabase/supabase-js'
    - PostgreSQL dependencies

  to_be_removed_phase2:
    - '@opennextjs/cloudflare'
    - Next.js (move to Hono)
    - OpenNext adapter code

# Archive
archive:
  branches:
    - archive/supabase (pre-migration state)
    - archive/opennext (Phase 1 complete state, future)

  documentation:
    - MIGRATION_ANALYSIS.md (root level, to be integrated)
    - .agents/ directory (migrated to .governance/)

# Trace
trace:
  specs:
    - SPEC-migration-supabase-to-cloudflare-1
    - SPEC-migration-opennext-to-workers-1
    - SPEC-devtool-pre-commit-1

  tasks:
    - TASK-migration-001 through TASK-migration-018
    - TASK-workers-001 through TASK-workers-004 (planned)

  catalogs:
    - database-migration (migrated to .governance/patterns.md)
    - authentication (migrated to .governance/patterns.md)

  profiles:
    - cloudflare-workers@2025-11-06 (migrated to .governance/patterns.md)
